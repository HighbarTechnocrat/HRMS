(function(e){e.fn.extend({autocomplete:function(t,n){var r=typeof t=="string";n=e.extend({},e.Autocompleter.defaults,{url:r?t:null,data:r?null:t,delay:r?e.Autocompleter.defaults.delay:10,max:n&&!n.scroll?10:150},n);n.highlight=n.highlight||function(e){return e};n.formatMatch=n.formatMatch||n.formatItem;return this.each(function(){new e.Autocompleter(this,n)})},result:function(e){return this.bind("result",e)},search:function(e){return this.trigger("search",[e])},flushCache:function(){return this.trigger("flushCache")},setOptions:function(e){return this.trigger("setOptions",[e])},unautocomplete:function(){return this.trigger("unautocomplete")}});e.Autocompleter=function(t,n){function r(){var e=S.selected();if(!e)return false;var t=e.result;g=t;if(n.multiple){var r=s(v.val());if(r.length>1){t=r.slice(0,r.length-1).join(n.multipleSeparator)+n.multipleSeparator+t}t+=n.multipleSeparator}v.val(t);f();v.trigger("result",[e.data,e.value]);return true}function i(e,t){if(w==d.DEL){S.hide();return}var r=v.val();if(!t&&r==g)return;g=r;r=o(r);if(r.length>=n.minChars){v.addClass(n.loadingClass);if(!n.matchCase)r=r.toLowerCase();c(r,l,f)}else{p();S.hide()}}function s(t){if(!t){return[""]}var r=t.split(n.multipleSeparator);var i=[];e.each(r,function(t,n){if(e.trim(n))i[t]=e.trim(n)});return i}function o(e){if(!n.multiple)return e;var t=s(e);return t[t.length-1]}function u(r,i){if(n.autoFill&&o(v.val()).toLowerCase()==r.toLowerCase()&&w!=d.BACKSPACE){v.val(v.val()+i.substring(o(g).length));e.Autocompleter.Selection(t,g.length,g.length+i.length)}}function a(){clearTimeout(m);m=setTimeout(f,200)}function f(){var r=S.visible();S.hide();clearTimeout(m);p();if(n.mustMatch){v.search(function(e){if(!e){if(n.multiple){var t=s(v.val()).slice(0,-1);v.val(t.join(n.multipleSeparator)+(t.length?n.multipleSeparator:""))}else v.val("")}})}if(r)e.Autocompleter.Selection(t,t.value.length,t.value.length)}function l(e,t){if(t&&t.length&&b){p();S.display(t,e);u(e,t[0].value);S.show()}else{f()}}function c(r,i,s){if(!n.matchCase)r=r.toLowerCase();var u=y.load(r);if(u&&u.length){i(r,u)}else if(typeof n.url=="string"&&n.url.length>0){var a={timestamp:+(new Date)};e.each(n.extraParams,function(e,t){a[e]=typeof t=="function"?t():t});e.ajax({mode:"abort",port:"autocomplete"+t.name,dataType:n.dataType,url:n.url,data:e.extend({q:o(r),limit:n.max},a),success:function(e){var t=n.parse&&n.parse(e)||h(e);y.add(r,t);i(r,t)}})}else{S.emptyList();s(r)}}function h(t){var r=[];var i=t.split("\n");for(var s=0;s<i.length;s++){var o=e.trim(i[s]);if(o){o=o.split("|");r[r.length]={data:o,value:o[0],result:n.formatResult&&n.formatResult(o,o[0])||o[0]}}}return r}function p(){v.removeClass(n.loadingClass)}var d={UP:38,DOWN:40,DEL:46,TAB:9,RETURN:13,ESC:27,COMMA:188,PAGEUP:33,PAGEDOWN:34,BACKSPACE:8};var v=e(t).attr("autocomplete","off").addClass(n.inputClass);var m;var g="";var y=e.Autocompleter.Cache(n);var b=0;var w;var E={mouseDownOnSelect:false};var S=e.Autocompleter.Select(n,t,r,E);var x;e.browser.opera&&e(t.form).bind("submit.autocomplete",function(){if(x){x=false;return false}});v.bind((e.browser.opera?"keypress":"keydown")+".autocomplete",function(t){w=t.keyCode;switch(t.keyCode){case d.UP:t.preventDefault();if(S.visible()){S.prev()}else{i(0,true)}break;case d.DOWN:t.preventDefault();if(S.visible()){S.next()}else{i(0,true)}break;case d.PAGEUP:t.preventDefault();if(S.visible()){S.pageUp()}else{i(0,true)}break;case d.PAGEDOWN:t.preventDefault();if(S.visible()){S.pageDown()}else{i(0,true)}break;case n.multiple&&e.trim(n.multipleSeparator)==","&&d.COMMA:case d.TAB:case d.RETURN:if(r()){t.preventDefault();x=true;return false}break;case d.ESC:S.hide();break;default:clearTimeout(m);m=setTimeout(i,n.delay);break}}).focus(function(){b++}).blur(function(){b=0;if(!E.mouseDownOnSelect){a()}}).click(function(){if(b++>1&&!S.visible()){i(0,true)}}).bind("search",function(){function t(e,t){var r;if(t&&t.length){for(var i=0;i<t.length;i++){if(t[i].result.toLowerCase()==e.toLowerCase()){r=t[i];break}}}if(typeof n=="function")n(r);else v.trigger("result",r&&[r.data,r.value])}var n=arguments.length>1?arguments[1]:null;e.each(s(v.val()),function(e,n){c(n,t,t)})}).bind("flushCache",function(){y.flush()}).bind("setOptions",function(){e.extend(n,arguments[1]);if("data"in arguments[1])y.populate()}).bind("unautocomplete",function(){S.unbind();v.unbind();e(t.form).unbind(".autocomplete")})};e.Autocompleter.defaults={inputClass:"ac_input",resultsClass:"ac_results",loadingClass:"ac_loading",minChars:1,delay:400,matchCase:false,matchSubset:true,matchContains:false,cacheLength:10,max:100,mustMatch:false,extraParams:{},selectFirst:true,formatItem:function(e){return e[0]},formatMatch:null,autoFill:false,width:0,multiple:false,multipleSeparator:", ",highlight:function(e,t){return e.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+t.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},scroll:true,scrollHeight:180};e.Autocompleter.Cache=function(t){function n(e,n){if(!t.matchCase)e=e.toLowerCase();var r=e.indexOf(n);if(t.matchContains=="word"){r=e.toLowerCase().search("\\b"+n.toLowerCase())}if(r==-1)return false;return r==0||t.matchContains}function r(e,n){if(u>t.cacheLength){s()}if(!o[e]){u++}o[e]=n}function i(){if(!t.data)return false;var n={},i=0;if(!t.url)t.cacheLength=1;n[""]=[];for(var s=0,o=t.data.length;s<o;s++){var u=t.data[s];u=typeof u=="string"?[u]:u;var a=t.formatMatch(u,s+1,t.data.length);if(a===false)continue;var f=a.charAt(0).toLowerCase();if(!n[f])n[f]=[];var l={value:a,data:u,result:t.formatResult&&t.formatResult(u)||a};n[f].push(l);if(i++<t.max){n[""].push(l)}}e.each(n,function(e,n){t.cacheLength++;r(e,n)})}function s(){o={};u=0}var o={};var u=0;setTimeout(i,25);return{flush:s,add:r,populate:i,load:function(r){if(!t.cacheLength||!u)return null;if(!t.url&&t.matchContains){var i=[];for(var s in o){if(s.length>0){var a=o[s];e.each(a,function(e,t){if(n(t.value,r)){i.push(t)}})}}return i}else if(o[r]){return o[r]}else if(t.matchSubset){for(var f=r.length-1;f>=t.minChars;f--){var a=o[r.substr(0,f)];if(a){var i=[];e.each(a,function(e,t){if(n(t.value,r)){i[i.length]=t}});return i}}}return null}}};e.Autocompleter.Select=function(t,n,r,i){function s(){if(!m)return;g=e("<div/>").hide().addClass(t.resultsClass).css("position","absolute").appendTo(document.body);y=e("<ul/>").appendTo(g).mouseover(function(t){if(o(t).nodeName&&o(t).nodeName.toUpperCase()=="LI"){p=e("li",y).removeClass(c.ACTIVE).index(o(t));e(o(t)).addClass(c.ACTIVE)}}).click(function(t){e(o(t)).addClass(c.ACTIVE);r();n.focus();return false}).mousedown(function(){i.mouseDownOnSelect=true}).mouseup(function(){i.mouseDownOnSelect=false});if(t.width>0)g.css("width",t.width);m=false}function o(e){var t=e.target;while(t&&t.tagName!="LI")t=t.parentNode;if(!t)return[];return t}function u(e){h.slice(p,p+1).removeClass(c.ACTIVE);a(e);var n=h.slice(p,p+1).addClass(c.ACTIVE);if(t.scroll){var r=0;h.slice(0,p).each(function(){r+=this.offsetHeight});if(r+n[0].offsetHeight-y.scrollTop()>y[0].clientHeight){y.scrollTop(r+n[0].offsetHeight-y.innerHeight())}else if(r<y.scrollTop()){y.scrollTop(r)}}}function a(e){p+=e;if(p<0){p=h.size()-1}else if(p>=h.size()){p=0}}function f(e){return t.max&&t.max<e?t.max:e}function l(){y.empty();var n=f(d.length);for(var r=0;r<n;r++){if(!d[r])continue;var i=t.formatItem(d[r].data,r+1,n,d[r].value,v);if(i===false)continue;var s=e("<li/>").html(t.highlight(i,v)).addClass(r%2==0?"ac_even":"ac_odd").appendTo(y)[0];e.data(s,"ac_data",d[r])}h=y.find("li");if(t.selectFirst){h.slice(0,1).addClass(c.ACTIVE);p=0}if(e.fn.bgiframe)y.bgiframe()}var c={ACTIVE:"ac_over"};var h,p=-1,d,v="",m=true,g,y;return{display:function(e,t){s();d=e;v=t;l()},next:function(){u(1)},prev:function(){u(-1)},pageUp:function(){if(p!=0&&p-8<0){u(-p)}else{u(-8)}},pageDown:function(){if(p!=h.size()-1&&p+8>h.size()){u(h.size()-1-p)}else{u(8)}},hide:function(){g&&g.hide();h&&h.removeClass(c.ACTIVE);p=-1},visible:function(){return g&&g.is(":visible")},current:function(){return this.visible()&&(h.filter("."+c.ACTIVE)[0]||t.selectFirst&&h[0])},show:function(){var r=e(n).offset();g.css({width:typeof t.width=="string"||t.width>0?t.width:e(n).width(),top:r.top+n.offsetHeight,left:r.left}).show();if(t.scroll){y.scrollTop(0);y.css({maxHeight:t.scrollHeight,overflow:"auto"});if(e.browser.msie&&typeof document.body.style.maxHeight==="undefined"){var i=0;h.each(function(){i+=this.offsetHeight});var s=i>t.scrollHeight;y.css("height",s?t.scrollHeight:i);if(!s){h.width(y.width()-parseInt(h.css("padding-left"))-parseInt(h.css("padding-right")))}}}},selected:function(){var t=h&&h.filter("."+c.ACTIVE).removeClass(c.ACTIVE);return t&&t.length&&e.data(t[0],"ac_data")},emptyList:function(){y&&y.empty()},unbind:function(){g&&g.remove()}}};e.Autocompleter.Selection=function(e,t,n){if(e.createTextRange){var r=e.createTextRange();r.collapse(true);r.moveStart("character",t);r.moveEnd("character",n);r.select()}else if(e.setSelectionRange){e.setSelectionRange(t,n)}else{if(e.selectionStart){e.selectionStart=t;e.selectionEnd=n}}e.focus()}})(jQuery)
